# Property Multilingual (i18n) Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Add zh-TW / ja / en support to property content fields, with a one-time Claude API migration script to auto-translate existing Chinese data.

**Architecture:** Translatable string fields (name, shortDesc, etc.) change from plain strings to JSON objects `{"zh-TW":"...","ja":"...","en":"..."}` stored in the same TEXT columns. A `localizeField(val, lang)` helper extracts the right value everywhere. SSR renders zh-TW; the client re-renders on language switch using stored regions data. A one-time migration script translates existing properties via Claude API.

**Tech Stack:** better-sqlite3, Express, vanilla JS, Anthropic claude-haiku-4-5-20251001 API (via fetch, no new package).

---

## Fields being made multilingual

**Simple string fields (9):** `name`, `shortDesc`, `introduction`, `transportInfo`, `transportDetail`, `badge`, `secondaryBadge`, `address`, `nearestStation`

**JSON array fields — text sub-fields only:**
- `quickInfo[].title`, `quickInfo[].value`, `quickInfo[].desc`
- `spaceIntro[].title`, `spaceIntro[].desc`

**NOT changed:** `id`, `type`, `regionId`, `capacity`, `size`, `videoUrl`, `mapEmbedUrl`, `airbnbUrl`, `ical_url`, `checkIn`, `checkOut`, `amenities`, timestamps.

---

## Task 1: Add `localizeField()` helper and update SSR card renderer

**Files:**
- Modify: `server.js` (around lines 353–415)

### Step 1: Add `localizeField()` before `ssrRenderCard`

Find in `server.js` (line 356):
```js
function ssrRenderCard(property, delay) {
```

Insert the following **immediately before** that line:

```js
/**
 * Extract the display value for `lang` from a multilingual field.
 * Handles: plain string (backward compat), JSON object, or JSON string.
 */
function localizeField(val, lang) {
  if (val === null || val === undefined) return '';
  if (typeof val === 'object') return val[lang] || val['zh-TW'] || '';
  if (typeof val === 'string' && val.startsWith('{')) {
    try { const o = JSON.parse(val); return o[lang] || o['zh-TW'] || val; } catch (e) {}
  }
  return val;
}

```

### Step 2: Update `ssrRenderCard` to accept `lang` and use `localizeField`

Find `function ssrRenderCard(property, delay) {` (line 356 after Task 1 shift).

Replace the entire function body with:

```js
function ssrRenderCard(property, delay, lang) {
  lang = lang || 'zh-TW';
  const name          = localizeField(property.name, lang);
  const shortDesc     = localizeField(property.shortDesc, lang);
  const badge         = localizeField(property.badge, lang);
  const secondaryBadge = localizeField(property.secondaryBadge, lang);
  const address       = localizeField(property.address, lang);
  const transportInfo = localizeField(property.transportInfo, lang);

  const coverUrl = (property.images && property.images.length > 0) ? property.images[0].url || '' : '';
  const badgeIcon = (badge === '公寓式民宿' || property.type === '公寓式民宿') ? APARTMENT_ICON_SVG : HOUSE_ICON_SVG;
  const delayAttr = delay > 0 ? ` style="animation-delay: ${delay}s;"` : '';

  return `<div class="property-card animate-fadeInUp"${delayAttr}>` +
    `<div class="relative aspect-[4/3] overflow-hidden">` +
      `<img src="${escHtml(coverUrl)}" alt="${escHtml(name)}" loading="lazy" class="w-full h-full object-cover card-image">` +
      `<div class="image-overlay"></div>` +
      `<div class="absolute top-4 left-4"><span class="badge">${badgeIcon} ${escHtml(badge)}</span></div>` +
      (secondaryBadge ? `<div class="absolute bottom-4 right-4 bg-white/95 backdrop-blur-sm rounded-lg px-3 py-1.5"><span class="text-amber-800 font-bold text-sm">${escHtml(secondaryBadge)}</span></div>` : '') +
    `</div>` +
    `<div class="p-6 flex flex-col flex-1">` +
      `<h3 class="font-bold text-xl text-amber-900 mb-1">${escHtml(name)}</h3>` +
      `<p class="text-amber-500 text-sm mb-4">${escHtml(shortDesc)}</p>` +
      `<div class="space-y-1 mb-5">` +
        `<div class="info-item"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/></svg><span>${escHtml(address)}</span></div>` +
        `<div class="info-item"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg><span>${escHtml(transportInfo)}</span></div>` +
      `</div>` +
      `<a href="rooms/${escHtml(property.id)}.html" class="btn-primary w-full mt-auto"><span>查看詳情</span><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"/></svg></a>` +
    `</div>` +
  `</div>`;
}
```

### Step 3: Pass `lang` through `ssrRenderRegion` to `ssrRenderCard`

Find `function ssrRenderRegion(region, properties, isOdd) {` (line ~379).

Change the signature and the card call:

```js
// Change signature from:
function ssrRenderRegion(region, properties, isOdd) {
// To:
function ssrRenderRegion(region, properties, isOdd, lang) {
  lang = lang || 'zh-TW';
```

Then find inside that function:
```js
    if (count === 1) cardsHtml += `<div class="w-full max-w-sm">${ssrRenderCard(properties[i], delay)}</div>`;
    else if (count >= 5) cardsHtml += `<div class="w-full md:w-[calc(33.333%-1.4rem)]">${ssrRenderCard(properties[i], delay)}</div>`;
    else cardsHtml += ssrRenderCard(properties[i], delay);
```

Replace with:
```js
    if (count === 1) cardsHtml += `<div class="w-full max-w-sm">${ssrRenderCard(properties[i], delay, lang)}</div>`;
    else if (count >= 5) cardsHtml += `<div class="w-full md:w-[calc(33.333%-1.4rem)]">${ssrRenderCard(properties[i], delay, lang)}</div>`;
    else cardsHtml += ssrRenderCard(properties[i], delay, lang);
```

Find `function ssrRenderAllRegions(regions) {` and update its call:
```js
// Change from:
    html += ssrRenderRegion(region, region.properties, idx % 2 === 0);
// To:
    html += ssrRenderRegion(region, region.properties, idx % 2 === 0, 'zh-TW');
```

### Step 4: Verify syntax

```bash
node --check /home/1267721.cloudwaysapps.com/yuqqxgzmck/public_html/server.js && echo "OK"
```
Expected: `OK`

### Step 5: Commit

```bash
cd /home/1267721.cloudwaysapps.com/yuqqxgzmck/public_html
git add server.js
git commit -m "feat: add localizeField() helper, update SSR card renderer for i18n"
```

---

## Task 2: Update property save handler + inject `window.__PROPERTY_DATA` in room page

**Files:**
- Modify: `server.js` (lines ~913–974 save handler, lines ~555–673 room SSR route)

### Step 1: Update the property save handler to JSON-stringify multilingual string fields

The save handler at line ~929 runs an UPDATE (or INSERT). Currently simple string fields are passed directly: `p.name, p.badge, ...`. After this change the admin sends objects, so we must stringify them.

Find the `UPDATE properties SET` statement (line ~929). It has this run() call:

```js
      p.name, p.type || '包棟民宿', p.regionId || null, regionZh, regionEn, regionDesc,
      p.badge || '', p.secondaryBadge || '', p.shortDesc || '', p.address || '',
      p.transportInfo || '', p.introduction || '', p.videoUrl || '', p.mapEmbedUrl || '',
      p.airbnbUrl || '', p.capacity || '', p.size || '', p.checkIn || '下午3點以後',
      p.checkOut || '上午10點之前', p.transportDetail || '',
      JSON.stringify(p.quickInfo || []), JSON.stringify(p.amenities || []),
      JSON.stringify(p.spaceIntro || []), p.nearestStation || '', p.icalUrl || '', p.id
```

Define a helper inline at the top of the route handler to serialize multilingual fields (objects get stringified, strings stay as-is):

Add this line right after `const p = req.body;`:
```js
  const ml = (v) => v && typeof v === 'object' && !Array.isArray(v) ? JSON.stringify(v) : (v || '');
```

Then replace the run() arguments for the UPDATE (not changing `JSON.stringify(p.quickInfo)` etc. — those stay):

```js
      ml(p.name), p.type || '包棟民宿', p.regionId || null, regionZh, regionEn, regionDesc,
      ml(p.badge), ml(p.secondaryBadge), ml(p.shortDesc), ml(p.address),
      ml(p.transportInfo), ml(p.introduction), p.videoUrl || '', p.mapEmbedUrl || '',
      p.airbnbUrl || '', p.capacity || '', p.size || '', p.checkIn || '下午3點以後',
      p.checkOut || '上午10點之前', ml(p.transportDetail),
      JSON.stringify(p.quickInfo || []), JSON.stringify(p.amenities || []),
      JSON.stringify(p.spaceIntro || []), ml(p.nearestStation), p.icalUrl || '', p.id
```

Apply the same change to the INSERT run() arguments (same fields, same order minus `p.id` which is first in INSERT).

### Step 2: Inject `window.__PROPERTY_DATA` into room SSR page

Find in `server.js` the room SSR route `app.get('/rooms/:id.html', ...)`. Near the end (around line 665–672):

```js
  let html = roomTemplate;
  html = html.replace(/<title>[^<]*<\/title>/, seoHead);
  html = html.replace('</main>', ssrContent + '\n  </main>');

  res.setHeader('Content-Type', 'text/html; charset=utf-8');
  res.send(html);
```

Replace with:

```js
  let html = roomTemplate;
  html = html.replace(/<title>[^<]*<\/title>/, seoHead);
  html = html.replace('</main>', ssrContent + '\n  </main>');
  // Inject full multilingual property data for client-side language switching
  const propDataScript = `<script>window.__PROPERTY_DATA = ${JSON.stringify(p)};</script>`;
  html = html.replace('</body>', propDataScript + '\n</body>');

  res.setHeader('Content-Type', 'text/html; charset=utf-8');
  res.send(html);
```

### Step 3: Verify

```bash
node --check /home/1267721.cloudwaysapps.com/yuqqxgzmck/public_html/server.js && echo "OK"
```

### Step 4: Commit

```bash
git add server.js
git commit -m "feat: serialize multilingual fields on save, inject __PROPERTY_DATA in room SSR"
```

---

## Task 3: Update client-side renderer in index.html for multilingual

**Files:**
- Modify: `index.html` (renderer IIFE ~lines 1779–1990, setLanguage ~lines 2127–2171)

### Step 1: Add `localizeField()` helper in the renderer IIFE

Find the start of the renderer IIFE. Look for:
```js
      // Dynamic Properties Renderer
```

Immediately after the opening `(function() {` of that IIFE, add:

```js
      // Multilingual field helper — handles plain string (backward compat) and {"zh-TW":...} objects
      function localizeField(val, lang) {
        if (val === null || val === undefined) return '';
        if (typeof val === 'object') return val[lang] || val['zh-TW'] || '';
        if (typeof val === 'string' && val.charAt(0) === '{') {
          try { var o = JSON.parse(val); return o[lang] || o['zh-TW'] || val; } catch (e) {}
        }
        return val;
      }

      function getCurrentLang() {
        return localStorage.getItem('lang') || 'zh-TW';
      }

```

### Step 2: Update `renderCard()` to use `localizeField`

Find `function renderCard(property, delay) {` (line ~1802). Replace the top of that function:

```js
      function renderCard(property, delay) {
        var lang = getCurrentLang();
        var name          = localizeField(property.name, lang);
        var shortDesc     = localizeField(property.shortDesc, lang);
        var badge         = localizeField(property.badge, lang);
        var secondaryBadge = localizeField(property.secondaryBadge, lang);
        var address       = localizeField(property.address, lang);
        var transportInfo = localizeField(property.transportInfo, lang);

        var coverUrl = getCoverImage(property);
        var badgeIcon = getBadgeIcon(badge, property.type);
        var delayAttr = delay > 0 ? ' style="animation-delay: ' + delay + 's;"' : '';
```

Then update all references inside the function from `property.name` → `name`, `property.shortDesc` → `shortDesc`, `property.badge` → `badge`, `property.secondaryBadge` → `secondaryBadge`, `property.address` → `address`, `property.transportInfo` → `transportInfo`.

Also update the alt text and aria (line ~1809): `escHtml(property.name)` → `escHtml(name)`.

### Step 3: Store regions data globally for language switching

Find the fetch success handler (line ~1982):

```js
        .then(function(data) {
          if (Array.isArray(data) && data.length > 0) {
            renderAllRegions(data);
          }
        })
```

Replace with:

```js
        .then(function(data) {
          if (Array.isArray(data) && data.length > 0) {
            window.__API_REGIONS = data; // store for language switching
            renderAllRegions(data);
          }
        })
```

Also update the SSR hydration block (line ~1963):

```js
      if (window.__SSR_REGIONS && window.__SSR_REGIONS.length > 0) {
        var container = document.getElementById('propertiesContainer');
        var activeRegions = window.__SSR_REGIONS;
        renderFilterBar(activeRegions);
        container.querySelectorAll('.animate-fadeInUp, .animate-scaleIn').forEach(function(el) {
          el.style.animationPlayState = 'paused';
          observer.observe(el);
        });
        return; // skip fetch
      }
```

Replace `return; // skip fetch` with nothing — remove the `return` so the page still wires up the filter but also stores SSR regions for language switching. Actually, keep the return but before it, don't store — the data is already in `window.__SSR_REGIONS`. Instead we'll use it in setLanguage.

Keep as-is (the return is intentional to skip the fetch). We'll use `window.__SSR_REGIONS` in `setLanguage`.

### Step 4: Re-render cards in `setLanguage()` when language changes

Find `setLanguage` function (line ~2127). After the `data-i18n` forEach loop (line ~2143), add:

```js
      // Re-render property cards in the new language
      var regionsData = window.__SSR_REGIONS || window.__API_REGIONS;
      if (regionsData) {
        var container = document.getElementById('propertiesContainer');
        if (container && container.children.length > 0) {
          renderAllRegions(regionsData);
        }
      }
```

Note: `renderAllRegions` already calls `renderFilterBar` and sets up animations internally, so this is safe.

### Step 5: Verify

Open the page. Switch language — property card names/descriptions should change.

```bash
# Verify no syntax errors in script blocks (node can't parse HTML directly,
# but check there are no obvious issues by searching for key patterns):
grep -c 'localizeField' /home/1267721.cloudwaysapps.com/yuqqxgzmck/public_html/index.html
```
Expected: at least 7 (definition + 6 usages in renderCard).

### Step 6: Commit

```bash
git add index.html
git commit -m "feat: multilingual property card rendering, re-render on language switch"
```

---

## Task 4: Update admin.html property form with language tabs

**Files:**
- Modify: `views/admin.html`

This task adds language tab UI to all A+B translatable fields. The pattern mirrors the hero section tabs (`switchHeroTextTab`).

### Step 1: Add the tab-switching function

Find `function switchHeroTextTab(lang)` in admin.html. Immediately after its closing `}`, add:

```js
    function switchPropLangTab(lang) {
      ['zh-TW', 'ja', 'en'].forEach(function(l) {
        var tab = document.getElementById('prop-tab-' + l);
        var fields = document.querySelectorAll('.prop-lang-fields[data-lang="' + l + '"]');
        if (tab) tab.classList.toggle('active', l === lang);
        fields.forEach(function(f) { f.classList.toggle('hidden', l !== lang); });
      });
    }
```

### Step 2: Add tab CSS (reuse existing tab styles)

The admin already has `.lang-tab` styles for the hero section. Add the selector to cover prop tabs too by searching for:
```css
    #hero-tab-zh-TW.active, #hero-tab-ja.active, #hero-tab-en.active {
```
and adding `#prop-tab-zh-TW.active, #prop-tab-ja.active, #prop-tab-en.active,` to the same rule (or find the `.active` tab style and ensure it covers these IDs). If the existing hero tab buttons use a generic `.active` class with inline styles, no CSS change is needed — just ensure the button element uses the same class.

### Step 3: Replace the "基本資訊" card fields with multilingual version

Find the card body with `f-name`, `f-shortDesc`, `f-badge`, `f-secondaryBadge`, `f-address`, `f-transportInfo` (lines ~375–421).

Replace the entire `<div class="card-body space-y-4">` block (containing name through transportInfo) with:

```html
<div class="card-body space-y-4">
  <input type="hidden" id="f-id">
  <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
    <div>
      <label class="form-label">所屬區域</label>
      <select id="f-regionId" class="form-input">
        <option value="">-- 請選擇區域 --</option>
      </select>
    </div>
    <div>
      <label class="form-label">房源類型</label>
      <select id="f-type" class="form-input">
        <option value="包棟民宿">包棟民宿</option>
        <option value="獨立式套房">獨立式套房</option>
        <option value="Guest House">Guest House</option>
      </select>
    </div>
  </div>

  <!-- Language tabs for translatable fields -->
  <div class="flex gap-2 border-b border-border-default pb-0 mt-2">
    <button type="button" id="prop-tab-zh-TW" onclick="switchPropLangTab('zh-TW')"
      class="px-4 py-2 text-sm font-medium border-b-2 border-transparent active">繁中</button>
    <button type="button" id="prop-tab-ja" onclick="switchPropLangTab('ja')"
      class="px-4 py-2 text-sm font-medium border-b-2 border-transparent">日文</button>
    <button type="button" id="prop-tab-en" onclick="switchPropLangTab('en')"
      class="px-4 py-2 text-sm font-medium border-b-2 border-transparent">英文</button>
  </div>

  <!-- zh-TW fields -->
  <div class="prop-lang-fields space-y-3" data-lang="zh-TW">
    <div><label class="form-label">房源名稱 (繁中) <span class="text-destructive">*</span></label>
      <input type="text" id="f-name-zh-TW" class="form-input" placeholder="例: 文華園 大正 Guest House" oninput="autoGenerateSlug()" onblur="checkNameDuplicate()"></div>
    <div><label class="form-label">簡短描述 (繁中)</label>
      <input type="text" id="f-shortDesc-zh-TW" class="form-input" placeholder="例: 全新裝潢・3間浴室"></div>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <div><label class="form-label">標籤 Badge (繁中)</label>
        <input type="text" id="f-badge-zh-TW" class="form-input" placeholder="例: 包棟民宿"></div>
      <div><label class="form-label">次要標籤 (繁中)</label>
        <input type="text" id="f-secondaryBadge-zh-TW" class="form-input" placeholder="例: 2025新開幕"></div>
    </div>
    <div><label class="form-label">地址 (繁中)</label>
      <input type="text" id="f-address-zh-TW" class="form-input" placeholder="例: 大阪市大正區三軒家西1-12-19"></div>
    <div><label class="form-label">交通資訊 (繁中)</label>
      <input type="text" id="f-transportInfo-zh-TW" class="form-input" placeholder="例: 大正車站4分鐘・心齋橋3站"></div>
  </div>

  <!-- ja fields -->
  <div class="prop-lang-fields hidden space-y-3" data-lang="ja">
    <div><label class="form-label">房源名稱 (日文)</label>
      <input type="text" id="f-name-ja" class="form-input" placeholder="例: 文華園 大正 ゲストハウス"></div>
    <div><label class="form-label">簡短描述 (日文)</label>
      <input type="text" id="f-shortDesc-ja" class="form-input"></div>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <div><label class="form-label">標籤 Badge (日文)</label>
        <input type="text" id="f-badge-ja" class="form-input"></div>
      <div><label class="form-label">次要標籤 (日文)</label>
        <input type="text" id="f-secondaryBadge-ja" class="form-input"></div>
    </div>
    <div><label class="form-label">地址 (日文)</label>
      <input type="text" id="f-address-ja" class="form-input"></div>
    <div><label class="form-label">交通資訊 (日文)</label>
      <input type="text" id="f-transportInfo-ja" class="form-input"></div>
  </div>

  <!-- en fields -->
  <div class="prop-lang-fields hidden space-y-3" data-lang="en">
    <div><label class="form-label">房源名稱 (英文)</label>
      <input type="text" id="f-name-en" class="form-input" placeholder="e.g. Bunkaken Taisho Guest House"></div>
    <div><label class="form-label">簡短描述 (英文)</label>
      <input type="text" id="f-shortDesc-en" class="form-input"></div>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <div><label class="form-label">標籤 Badge (英文)</label>
        <input type="text" id="f-badge-en" class="form-input"></div>
      <div><label class="form-label">次要標籤 (英文)</label>
        <input type="text" id="f-secondaryBadge-en" class="form-input"></div>
    </div>
    <div><label class="form-label">地址 (英文)</label>
      <input type="text" id="f-address-en" class="form-input"></div>
    <div><label class="form-label">交通資訊 (英文)</label>
      <input type="text" id="f-transportInfo-en" class="form-input"></div>
  </div>
</div>
```

### Step 4: Replace introduction, transportDetail, nearestStation with multilingual version

Find the card containing `f-introduction` (line ~458) and `f-transportDetail`, `f-nearestStation` (line ~563).

For **introduction** — find:
```html
    <label class="form-label">房源介紹</label>
    <textarea id="f-introduction" rows="5" class="form-input" ...></textarea>
```
Replace with three language textareas wrapped in lang divs (same pattern as above):
```html
    <label class="form-label">房源介紹</label>
    <div class="prop-lang-fields" data-lang="zh-TW">
      <textarea id="f-introduction-zh-TW" rows="5" class="form-input" placeholder="在這裡撰寫房源的詳細描述...&#10;&#10;每段用空行分隔，會自動分段顯示在詳情頁右側"></textarea>
    </div>
    <div class="prop-lang-fields hidden" data-lang="ja">
      <textarea id="f-introduction-ja" rows="5" class="form-input"></textarea>
    </div>
    <div class="prop-lang-fields hidden" data-lang="en">
      <textarea id="f-introduction-en" rows="5" class="form-input"></textarea>
    </div>
```

For **nearestStation** — find `id="f-nearestStation"` and apply same pattern (3 inputs with lang suffixes).

For **transportDetail** — find `id="f-transportDetail"` and apply same pattern (3 textareas with lang suffixes).

### Step 5: Replace quickInfo fields with multilingual version

Find the quickInfo card body (lines ~487–502) with `f-qi1Title`, `f-qi1Value`, `f-qi1Desc`, `f-qi2Title`, `f-qi2Value`, `f-qi2Desc`.

For each title/value/desc, add 3 language inputs inside prop-lang-fields divs. Example for qi1Title:

```html
<div class="prop-lang-fields" data-lang="zh-TW">
  <input type="text" id="f-qi1Title-zh-TW" class="form-input" placeholder="標題（例: 房源特色）">
</div>
<div class="prop-lang-fields hidden" data-lang="ja">
  <input type="text" id="f-qi1Title-ja" class="form-input">
</div>
<div class="prop-lang-fields hidden" data-lang="en">
  <input type="text" id="f-qi1Title-en" class="form-input">
</div>
```

Apply the same pattern to `qi1Value`, `qi1Desc`, `qi2Title`, `qi2Value`, `qi2Desc`.

### Step 6: Replace spaceIntro fields with multilingual version

Find spaceIntro card (lines ~531–555) with `f-si1Title`, `f-si1Desc`, etc.

Apply same 3-lang pattern to each of: `si1Title`, `si1Desc`, `si2Title`, `si2Desc`, `si3Title`, `si3Desc`, `si4Title`, `si4Desc`.

### Step 7: Update `autoGenerateSlug()` to read from `f-name-zh-TW`

Find `autoGenerateSlug()` in admin.html. It reads `document.getElementById('f-name').value`. Change to:
```js
    function autoGenerateSlug() {
      var nameEl = document.getElementById('f-name-zh-TW');
      // ... rest unchanged
```

Also update `checkNameDuplicate()` to read from `f-name-zh-TW`.

### Step 8: Update `loadPropertyToForm()` to populate per-language inputs

Find `loadPropertyToForm(prop)` (lines ~1338–1394). Replace the translatable field assignments:

```js
  // Helper: get lang value from multilingual field or plain string
  function getLang(val, lang) {
    if (!val) return '';
    if (typeof val === 'object') return val[lang] || '';
    if (typeof val === 'string' && val.charAt(0) === '{') {
      try { var o = JSON.parse(val); return o[lang] || ''; } catch(e) {}
    }
    return lang === 'zh-TW' ? val : ''; // plain string → zh-TW only
  }

  ['zh-TW', 'ja', 'en'].forEach(function(lang) {
    var el = function(id) { return document.getElementById(id + '-' + lang); };
    el('f-name').value          = getLang(prop.name, lang);
    el('f-shortDesc').value     = getLang(prop.shortDesc, lang);
    el('f-badge').value         = getLang(prop.badge, lang);
    el('f-secondaryBadge').value = getLang(prop.secondaryBadge, lang);
    el('f-address').value       = getLang(prop.address, lang);
    el('f-transportInfo').value = getLang(prop.transportInfo, lang);
    el('f-introduction').value  = getLang(prop.introduction, lang);
    el('f-nearestStation').value = getLang(prop.nearestStation, lang);
    el('f-transportDetail').value = getLang(prop.transportDetail, lang);
  });

  // quickInfo
  const qi = prop.quickInfo || [{},{}];
  ['zh-TW','ja','en'].forEach(function(lang) {
    var sfx = '-' + lang;
    document.getElementById('f-qi1Title'+sfx).value = getLang(qi[0] && qi[0].title, lang);
    document.getElementById('f-qi1Value'+sfx).value = getLang(qi[0] && qi[0].value, lang);
    document.getElementById('f-qi1Desc'+sfx).value  = getLang(qi[0] && qi[0].desc, lang);
    document.getElementById('f-qi2Title'+sfx).value = getLang(qi[1] && qi[1].title, lang);
    document.getElementById('f-qi2Value'+sfx).value = getLang(qi[1] && qi[1].value, lang);
    document.getElementById('f-qi2Desc'+sfx).value  = getLang(qi[1] && qi[1].desc, lang);
  });

  // spaceIntro
  const si = prop.spaceIntro || [{},{},{},{}];
  ['zh-TW','ja','en'].forEach(function(lang) {
    var sfx = '-' + lang;
    for (var n = 1; n <= 4; n++) {
      document.getElementById('f-si'+n+'Title'+sfx).value = getLang(si[n-1] && si[n-1].title, lang);
      document.getElementById('f-si'+n+'Desc'+sfx).value  = getLang(si[n-1] && si[n-1].desc, lang);
    }
  });
```

Remove the old single-field assignments for these fields.

### Step 9: Update `saveProperty()` to build multilingual objects

Find `saveProperty()` (lines ~1396–1462). Replace the prop object construction for translatable fields:

```js
  // Collect multilingual fields
  function collectLangs(baseId) {
    var obj = {};
    ['zh-TW','ja','en'].forEach(function(l) {
      var el = document.getElementById(baseId + '-' + l);
      obj[l] = el ? el.value.trim() : '';
    });
    return obj;
  }

  // Replace individual field reads with:
  var name = collectLangs('f-name')['zh-TW'];    // still validate zh-TW name
  if (!name) { showToast('請填寫房源名稱', 'error'); return; }

  var prop = {
    id: newId,
    name: collectLangs('f-name'),
    type: document.getElementById('f-type').value,
    regionId: selectedRegionId || currentRegionId,
    badge: collectLangs('f-badge'),
    secondaryBadge: collectLangs('f-secondaryBadge'),
    shortDesc: collectLangs('f-shortDesc'),
    address: collectLangs('f-address'),
    transportInfo: collectLangs('f-transportInfo'),
    introduction: collectLangs('f-introduction'),
    nearestStation: collectLangs('f-nearestStation'),
    transportDetail: collectLangs('f-transportDetail'),
    capacity: document.getElementById('f-capacity').value.trim(),
    size: document.getElementById('f-size').value.trim(),
    // ... (non-translatable fields unchanged)
    quickInfo: [
      {
        title: collectLangs('f-qi1Title'),
        value: collectLangs('f-qi1Value'),
        desc:  collectLangs('f-qi1Desc')
      },
      {
        title: collectLangs('f-qi2Title'),
        value: collectLangs('f-qi2Value'),
        desc:  collectLangs('f-qi2Desc')
      }
    ],
    spaceIntro: [1,2,3,4].map(function(n) {
      return {
        title: collectLangs('f-si'+n+'Title'),
        desc:  collectLangs('f-si'+n+'Desc')
      };
    }),
    // ... images, amenities unchanged
  };
```

### Step 10: Verify

Open admin panel, load an existing property. All 3 language tabs should appear. zh-TW tab shows existing Chinese content. ja and en tabs show empty inputs (until migration).

### Step 11: Commit

```bash
git add views/admin.html
git commit -m "feat: add language tabs to property form for i18n editing"
```

---

## Task 5: Create one-time migration script

**Files:**
- Create: `scripts/migrate-i18n.js`

This script reads all properties, calls Claude API to translate all translatable fields to ja and en, and writes the result back to the DB.

### Step 1: Create `scripts/` directory

```bash
mkdir -p /home/1267721.cloudwaysapps.com/yuqqxgzmck/public_html/scripts
```

### Step 2: Create `scripts/migrate-i18n.js`

```js
#!/usr/bin/env node
/**
 * One-time migration: translate existing property content to ja and en.
 * Run: node --env-file=.env scripts/migrate-i18n.js
 *
 * Requires ANTHROPIC_API_KEY in .env.
 * Safe to re-run: skips properties already in multilingual format.
 */

'use strict';
const Database = require('better-sqlite3');
const path = require('path');

const DB_PATH = path.join(__dirname, '..', 'osaka-minshuku.db');
const API_KEY = process.env.ANTHROPIC_API_KEY;

if (!API_KEY) {
  console.error('ERROR: ANTHROPIC_API_KEY not set in environment. Run with: node --env-file=.env scripts/migrate-i18n.js');
  process.exit(1);
}

const db = new Database(DB_PATH);

// Fields to translate (simple strings)
const STRING_FIELDS = ['name', 'shortDesc', 'introduction', 'transportInfo', 'transportDetail',
                       'badge', 'secondaryBadge', 'address', 'nearestStation'];

function safeParseJSON(val) {
  if (!val) return [];
  try { return JSON.parse(val); } catch (e) { return []; }
}

function isAlreadyMultilingual(val) {
  if (!val) return false;
  if (typeof val === 'string' && val.startsWith('{')) {
    try { const o = JSON.parse(val); return !!(o['zh-TW'] || o['ja'] || o['en']); } catch(e) {}
  }
  return false;
}

async function callClaude(prompt) {
  const res = await fetch('https://api.anthropic.com/v1/messages', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'x-api-key': API_KEY,
      'anthropic-version': '2023-06-01'
    },
    body: JSON.stringify({
      model: 'claude-haiku-4-5-20251001',
      max_tokens: 4096,
      messages: [{ role: 'user', content: prompt }]
    })
  });
  if (!res.ok) throw new Error('Claude API error: ' + res.status + ' ' + await res.text());
  const data = await res.json();
  return data.content[0].text.trim();
}

async function translateProperty(prop) {
  // Check if already migrated (all string fields are multilingual JSON)
  const alreadyDone = STRING_FIELDS.every(f => !prop[f] || isAlreadyMultilingual(prop[f]));
  if (alreadyDone) {
    console.log(`  [SKIP] ${prop.id} — already multilingual`);
    return null;
  }

  // Build translation prompt: send all fields at once to minimise API calls
  const fieldsToTranslate = {};
  for (const f of STRING_FIELDS) {
    if (prop[f] && !isAlreadyMultilingual(prop[f])) {
      fieldsToTranslate[f] = prop[f];
    }
  }

  // quickInfo sub-fields
  const qi = safeParseJSON(prop.quickInfo);
  const si = safeParseJSON(prop.spaceIntro);
  const qiTexts = [];
  qi.forEach((item, i) => {
    if (item.title) qiTexts.push({ key: `qi${i}title`, val: item.title });
    if (item.value) qiTexts.push({ key: `qi${i}value`, val: item.value });
    if (item.desc)  qiTexts.push({ key: `qi${i}desc`,  val: item.desc });
  });
  const siTexts = [];
  si.forEach((item, i) => {
    if (item.title) siTexts.push({ key: `si${i}title`, val: item.title });
    if (item.desc)  siTexts.push({ key: `si${i}desc`,  val: item.desc });
  });

  const allItems = [
    ...Object.entries(fieldsToTranslate).map(([k, v]) => ({ key: k, val: v })),
    ...qiTexts,
    ...siTexts
  ].filter(x => x.val && x.val.trim());

  if (allItems.length === 0) return null;

  const prompt = `You are translating Japanese vacation rental property content.
Translate each item from Traditional Chinese to both Japanese (ja) and English (en).
Return a JSON object mapping each key to {"ja":"...","en":"..."}.
Be natural and appropriate for a hospitality context.
Do NOT translate URLs, numbers, or symbols.

Items to translate:
${JSON.stringify(Object.fromEntries(allItems.map(x => [x.key, x.val])), null, 2)}

Return ONLY valid JSON, no explanation.`;

  const raw = await callClaude(prompt);

  // Parse response
  let translations;
  try {
    // Extract JSON from response (Claude may wrap in ```json blocks)
    const match = raw.match(/\{[\s\S]*\}/);
    translations = JSON.parse(match ? match[0] : raw);
  } catch (e) {
    throw new Error('Failed to parse Claude response: ' + raw.substring(0, 200));
  }

  // Build updated values
  const updates = {};

  // Simple string fields
  for (const [key, zhVal] of Object.entries(fieldsToTranslate)) {
    const t = translations[key] || {};
    updates[key] = JSON.stringify({ 'zh-TW': zhVal, ja: t.ja || zhVal, en: t.en || zhVal });
  }

  // quickInfo
  if (qi.length > 0) {
    const newQi = qi.map((item, i) => {
      const newItem = { ...item };
      if (item.title) {
        const t = translations[`qi${i}title`] || {};
        newItem.title = { 'zh-TW': item.title, ja: t.ja || item.title, en: t.en || item.title };
      }
      if (item.value) {
        const t = translations[`qi${i}value`] || {};
        newItem.value = { 'zh-TW': item.value, ja: t.ja || item.value, en: t.en || item.value };
      }
      if (item.desc) {
        const t = translations[`qi${i}desc`] || {};
        newItem.desc = { 'zh-TW': item.desc, ja: t.ja || item.desc, en: t.en || item.desc };
      }
      return newItem;
    });
    updates.quickInfo = JSON.stringify(newQi);
  }

  // spaceIntro
  if (si.length > 0) {
    const newSi = si.map((item, i) => {
      const newItem = { ...item };
      if (item.title) {
        const t = translations[`si${i}title`] || {};
        newItem.title = { 'zh-TW': item.title, ja: t.ja || item.title, en: t.en || item.title };
      }
      if (item.desc) {
        const t = translations[`si${i}desc`] || {};
        newItem.desc = { 'zh-TW': item.desc, ja: t.ja || item.desc, en: t.en || item.desc };
      }
      return newItem;
    });
    updates.spaceIntro = JSON.stringify(newSi);
  }

  return updates;
}

async function main() {
  const props = db.prepare('SELECT * FROM properties').all();
  console.log(`Found ${props.length} properties to process.\n`);

  let success = 0, skipped = 0, failed = 0;

  for (const prop of props) {
    console.log(`Processing: ${prop.id} (${prop.name})`);
    try {
      const updates = await translateProperty(prop);
      if (!updates) { skipped++; continue; }

      // Build SET clause from updates
      const setClauses = Object.keys(updates).map(k => `${k} = ?`).join(', ');
      const values = [...Object.values(updates), prop.id];
      db.prepare(`UPDATE properties SET ${setClauses} WHERE id = ?`).run(...values);

      console.log(`  [OK] ${prop.id} — translated ${Object.keys(updates).length} fields`);
      success++;

      // Small delay to avoid rate limiting
      await new Promise(r => setTimeout(r, 500));
    } catch (err) {
      console.error(`  [FAIL] ${prop.id}: ${err.message}`);
      failed++;
    }
  }

  db.close();
  console.log(`\nDone. Success: ${success}, Skipped: ${skipped}, Failed: ${failed}`);
}

main().catch(err => { console.error(err); process.exit(1); });
```

### Step 3: Run the migration

```bash
cd /home/1267721.cloudwaysapps.com/yuqqxgzmck/public_html
node --env-file=.env scripts/migrate-i18n.js
```

Expected output:
```
Found N properties to process.

Processing: some-property-id (房源名稱)
  [OK] some-property-id — translated 11 fields
...
Done. Success: N, Skipped: 0, Failed: 0
```

### Step 4: Verify one property in DB

```bash
node -e "
const db = require('better-sqlite3')('osaka-minshuku.db');
const p = db.prepare('SELECT id, name, shortDesc FROM properties LIMIT 1').get();
console.log('id:', p.id);
console.log('name:', p.name);
console.log('shortDesc:', p.shortDesc);
db.close();
"
```

Expected: `name` and `shortDesc` values start with `{` and contain `zh-TW`, `ja`, `en` keys.

### Step 5: Commit

```bash
git add scripts/migrate-i18n.js
git commit -m "feat: add one-time i18n migration script for property translations"
```

---

## Final Verification

After all 5 tasks and the migration:

```bash
# 1. Syntax check
node --check server.js && echo "server.js OK"

# 2. Verify a property has multilingual name
node --env-file=.env -e "
const db = require('better-sqlite3')('osaka-minshuku.db');
const p = db.prepare('SELECT name, shortDesc FROM properties LIMIT 1').get();
const name = JSON.parse(p.name);
console.log('zh-TW:', name['zh-TW']);
console.log('ja:', name['ja']);
console.log('en:', name['en']);
db.close();
"

# 3. Check localizeField is in index.html
grep -c 'localizeField' index.html
# Expected: >= 7

# 4. Check admin form has language tabs
grep -c 'prop-tab-' views/admin.html
# Expected: 3 (zh-TW, ja, en tab buttons)

# 5. Check migration script exists
ls scripts/migrate-i18n.js
```
